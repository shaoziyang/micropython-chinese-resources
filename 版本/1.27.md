# 1.27，2025-12-10   
**ESP32C5、ESP32P4 和 STM32U5 支持、增强测试套件、移植层级**

在这个版本中增加了对 ESP32-C5 和 ESP32-P4 微控制器的支持。ESP32-P4 既可以作为通用处理器单独工作，也可以与外部无线协处理器配合使用，目前为 ESP32-C5 或 ESP32-C6。这三种方式以及新的 ESP32-C5 的开发板均提供了配置文件。   
此外还支持低功耗且高性能的 STM32U5xx 系列，支持 USB、ADC、DAC、UART、I2C、SPI 和 RTC，并支持 NUCLEO-U5A5ZJ-Q 的主板配置文件。

严格且持续的基于硬件的测试是 MicroPython 的重要组成部分，随着支持的硬件平台数量不断增加 — 以及测试套件的不断壮大 — 确保测试尽可能顺畅和自动化运行变得尤为重要。本版本通过对测试套件的多项改进取得了进展，例如：

- 自动检测目标是否支持 Unicode   
- 在可能的情况下，自动包含浮点测试   
- 总是包括压力测试   
- 改进使用 Slice 和 MicroPython 模块的测试跳过功能   
- 在运行原生测试时支持不同的预期输出   
- 测试在低内存条件下表现   
- 调整一些测试，使其能在最小构建上运行   
- 让所有测试运行者都使用 `-t` 参数来选择目标   
- 将部分测试转换为使用 `UNITEST`   
- 将部分特定硬件测试转换为跨平台测试   
- 添加串行（REPL）可靠性和吞吐量测试   
- 更新以使用 CPython 3.8.2 作为参考 Python 版本   
- 增加更多内部基准测试。   

为了支持在更多硬件目标上的测试且可扩展，本版本引入了板级专用的 `target_wiring.py` 配置。该功能允许在一个位置（一个文件）中定义给定硬件或电路板所有所需的测试相关硬件连接，定义随后导入并供需要的测试使用。除了提供默认定义外，该方案还允许定制硬件轻松指定自己的布线设置用于测试。首先，是所有 `machine.UART` 测试已被转换为使用 `target_wiring.py`。

随着测试套件的所有改进，MicroPython 持续集成（CI）测试现在可以在 Unix 最小版本上运行，尽可能多的测试也在 Zephyr 端口 CI 上运行。

MicroPython 现在定义了移植层级，将现有的 20 个移植按开发阶段分为四组。这旨在为每种硬件所获得的支持和发展水平设定预期。同时降低新移植的门槛，让它们能从低层级开始，逐步提升到第一层级。请查看顶级 `README.md` 和相关文档（ [https://docs.micropython.org/en/latest/develop/support\_tiers.html](https://docs.micropython.org/en/latest/develop/support_tiers.html)）。

本版本还取消了 MicroPython 构建脚本和工具中对 Python 2.7 的支持。Python 2.7 自 2020 年 1 月起已停止发布，所有现代作系统都支持 Python 3。

核心运行时还进行了许多改进、优化和漏洞修复，包括：更优的 32 位 RISC-V 代码生成以支持本地发射器和 Zba 操作码，支持自定义 `__import__` 回调中的相对导入，对 `dict` 视图支持 `bool` 和 `len` 一元操作，在re匹配和搜索方法中支持起始和结束位置，以及在`asyncio.start_server()`中支持IPv6。大多数硬件（除了 esp32）现在支持 `machine.Timer` 对象的软中断和硬中断回调。默认情况下，`sys`模块在所有功能级别都已启用。

本次发布中更新了一些第三方库：LittleFS现已更新至v2.11.2版本，TinyUSB更新至0.19.0-24版本，而stm32lib中的N6版本为1.2.0，WB版本为1.23.0，并新增了对U5的支持。mimxrt的`nxp_driver`子模块已进行重构，以与官方的mcux-sdk保持一致。

alif 新增了 `machine.RTC.datetime()` 函数，用于获取和设置实时时钟（RTC），以及 `time.time_ns()` 函数。此外，还修复了快速 USB 主机上的 USB 设备地址设置问题，并修复了 `machine.SPI.init()` 函数，使其仅更改请求的设置。   

esp32 移植已更新至 ESP-IDF v5.5.1 版本，如前所述，现在支持 ESP32-C5 和 ESP32-P4。TinyUSB 集成已得到改进，修复了影响REPL 可靠性的零长度数据包错误，并修复了带有 PSRAM 的硬件上 USB HID 报告为空的问题。`network.PPP` 的线程安全性已得到一些重要修复，`espnow` 模块现在可以设置速率而不会出错。所有 ESP32C6 上均已启用 I2S，并添加了新的 `esp32.wake_on_gpio()` 函数，以支持通过 GPIO 引脚唤醒 SoC。

qemu 移植版现在支持 64 位 RISC-V，并新增了 VIRT\_RV64 开发板定义，同时还新增了 MPS2\_AN500（Cortex-M7）和MPS3\_AN547（Cortex-M55）开发板。这些都有助于在不同架构上测试 MicroPython。

对于 rp2 移植版，DMA 通道在释放时现已正确停止；PIO 现在支持引脚封装，并修复了 RP2350B 上排引脚的使用问题；对于大于 31 的引脚，其引脚交替功能也已修复。此外，还为 RP2350 微控制器（MCU）增加了 UART\_AUX、XIP\_CS1、CORESIGHT\_TRACE 和 HSTX 的交替功能。

stm32 移植版加了对 STM32U5xx 系列微控制器（MCU）以及 STM32F469xx 的支持。STM32G0xx 增加了数模转换器（DAC）支持，并修复了模数转换器（ADC）、定时器（Timer(4)）和实时时钟（RTC）唤醒功能。STM32G4xx 现在配备了硬件 I2C 实现，而STM32L4xx 则支持 I2CTarget。LAN 现在支持 STM32N6xx 系列 MCU，包括支持 RTL8211 PHY 的千兆以太网。现在还可选支持使用 TinyUSB 作为 USB 协议栈，以取代现有的 STM USB 协议栈。虽然后者仍是默认的 USB 协议栈，但计划在未来的版本中逐步切换到 TinyUSB，允许用 Python 定义 USB 设备。

Unix 和 Windows 移植版的主 REPL 循环已被所有裸机端口使用的标准 REPL 循环取代。这让它更稳定，尤其是现在支持原始 REPL。

Zephyr端口已升级至Zephyr v4.2.0版本，现在包含 `machine.ADC` 类、一个连接原生 Zephyr 文件系统的新 VFS 接口、对 GC 分离堆的支持、为 `zsensor` 添加了设置/获取传感器属性功能，并支持硬件 IRQ 定时器回调。与其他裸机移植一样，现在会在启动时根据需要格式化默认闪存分区。新增的开发板包括 PocketBeagle 2、XIAO BLE NRF52840 SENSE 和 NXP MIMXRT1020 EVK。

本次发布新增的开发板包括：ESP32\_GENERIC\_C2 FLASH\_2M 版本、ESP32\_GENERIC\_C5、ESP32\_GENERIC\_P4 标准版、C5\_WIFI 和 C6\_WIFI 版本、SIL\_MANT1S 和 SOLDERED\_NULA\_MINI（esp32）、NUCLEO\_H7A3ZI\_Q、NUCLEO\_U5A5ZJ\_Q、STM32F469DISC 和 WEACTSTUDIO\_MINI\_STM32H743（stm32）。

自上一版本以来，针对特定版本的代码大小变化为（文本部分的绝对和百分比变化）：
```
   bare-arm:   -180  -0.316%
minimal x86:   +867  +0.470%
   unix x64:  +2608  +0.309%
      stm32:    -68  -0.017%
     cc3200:   +112  +0.060%
    esp8266:   +472  +0.067%
      esp32: +36210  +2.120%
     mimxrt:   +280  +0.075%
 renesas-ra:   +104  +0.017%
        nrf:   +124  +0.066%
        rp2:  +3836  +1.117% (RPI_PICO board)
        rp2:  +1020  +0.111% (RPI_PICO_W board)
       samd:   +596  +0.220%
```

导致代码大小变化的主要原因包括：
- bare-arm：添加 MICROPY\_USE\_GCC\_MUL\_OVERFLOW\_INTRINSIC，避免可扩展模块列表为空。
- minimal x86：启用sys模块。
- unix：使用标准的裸机 REPL，更新 micropython-lib 子模块（包括对argparse的改进）。
- stm32：支持软 IRQ 定时器回调（重构），添加 MICROPY\_USE\_GCC\_MUL\_OVERFLOW\_INTRINSIC。
- cc3200：正确格式化带有分隔符的前导零，在正则表达式（re）中增加对起始和结束位置的支持，并对核心功能进行其他小幅改进。
- esp8266：支持硬件 IRQ 定时器回调，正确使用分隔符格式化前导零。
- esp32：使用IDF 5.5.1（+30k），更新 RMT 以使用新的 IDF API。
- mimxrt：更新 TinyUSB，在正则表达式中增加对起始和结束位置的支持。
- renesas-ra：正确格式化带分隔符的前导零，在正则表达式中增加对起始和结束位置的支持。
- nrf：打印 SPI 波特率、极性和相位，改进 UART 的超时处理，正确格式化带分隔符的前导零。
- rp2：启用hashlib.md5，更新TinyUSB。
- samd：更新TinyUSB，正确使用分隔符格式化前导零。

感谢所有为本次发行做出贡献的人：Alessandro Gatti, Alex Tran, Andrew Leech, Angus Gratton, Anson
Mansfield, Ayush Singh, Chris Liechti, Chris Mason, Chris Webb, Christian Clauss, Craftzman7, Damien George, Daniël van de Giessen, David Lechner, David Schneider, Dryw Wade, Elvis Pfutzenreuter, ennyKey, Florent, garywill, iabdalkader, Ihor Nehrutsa, Jared Hancock, Jeff Epler, Jimisola Laursen, John Smith, Jos Verlinde, Josip Šimun Kuči, Kwabena W. Agyeman, Matt Trentini, Maureen Helm, Meir Armon, Mike Tolkachev, Mike Wang, Ned Konz, Patrick Van Oosterwijck, Peter Harper, Phil Howard, robert-hh, Steve Sanbeg, stijn, Thomas Watson, Tico06, Vdragon, Vincent1-python, Yanfeng Liu, Yilin Sun, yuan\_mo, Yuuki NAGAO.   
   
